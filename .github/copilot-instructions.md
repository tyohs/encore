# Copilot PRレビュー指示書 - みんカラ

## プロジェクト概要

**みんカラ**は、カラオケを「参加する体験」に変える新感覚Webアプリです。
シンガー/バンド/オーディエンスの3つの役割でリアルタイム連携します。

### 技術スタック
- Next.js 16 (App Router) / TypeScript (strict)
- Tailwind CSS / Framer Motion
- Zustand (状態管理)
- BroadcastChannel API (リアルタイム同期)

### 参照ドキュメント
- [SPEC.md](../SPEC.md) - 詳細仕様書
- [README.md](../README.md) - プロジェクト概要

---

## PRレビュー出力フォーマット

### 結論（マージ可否）

- 推奨: ✅ 承認 / 🟡 修正後承認 / ❌ 差し戻し
- 理由: <最重要ポイントを1～2行で>

### 重要指摘（致命度の高い順）

1. [S][カテゴリ] <指摘内容を1行で>
   - 影響: <不具合/UX/パフォーマンス/セキュリティ 等>
   - 対応: <具体的な修正指示（ファイル/関数/方針）>

2. [M][カテゴリ] <指摘1行>
   - 対応: <修正方針>

3. [L][任意] <指摘1行>

> 重大度: S=重大(マージ不可) / M=中(要対応) / L=軽微(推奨)

### 変更概要（自動差分要約）

- 主要変更: <ディレクトリ/機能単位で1～3点>
- 破壊的変更: 有 / 無（あれば対象を明記）
- 影響範囲: シンガー / バンド / オーディエンス / 共通

---

## レビュー観点チェックリスト

### 🔷 基本品質
- [ ] **型安全**: `any` 不使用、適切な型定義
- [ ] **命名/可読性**: 意図が明確な命名、適切なコメント
- [ ] **エラーハンドリング**: try-catch、エラー境界、ユーザーフィードバック
- [ ] **null安全**: Optional chaining、nullish coalescing の適切な使用

### ⚡ パフォーマンス (リズムゲーム特有)
- [ ] **再レンダリング最適化**: useMemo/useCallback/React.memo の適切な使用
- [ ] **60fps維持**: requestAnimationFrame、重い処理の分離
- [ ] **メモリリーク**: useEffect のクリーンアップ、イベントリスナー解除
- [ ] **バンドル**: 不要なimport、動的import の検討

### 🔄 リアルタイム同期 (BroadcastChannel)
- [ ] **イベント設計**: メッセージ型の一貫性、適切なペイロード
- [ ] **エラー処理**: チャンネル切断時のフォールバック
- [ ] **同期タイミング**: 遅延を考慮した実装
- [ ] **クリーンアップ**: チャンネルの適切なclose

### 🎮 ゲームロジック
- [ ] **判定精度**: タイミング計算の正確性 (PERFECT/GREAT/GOOD/MISS)
- [ ] **スコア計算**: コンボ、倍率の正確性
- [ ] **状態管理**: Zustand store の更新が immutable
- [ ] **音声同期**: オーディオとビジュアルの同期

### 🎨 UI/UX (Glassmorphism準拠)
- [ ] **デザイン一貫性**: カラーパレット (#a855f7 紫基調)
- [ ] **レスポンシブ**: モバイル/タブレット対応
- [ ] **アニメーション**: Framer Motion の適切な使用、パフォーマンス
- [ ] **フィードバック**: 振動パターン、視覚フィードバック
- [ ] **アクセシビリティ**: フォーカス管理、ARIA属性

### 🔒 セキュリティ
- [ ] **XSS**: dangerouslySetInnerHTML 不使用、入力サニタイズ
- [ ] **機密情報**: .env の適切な管理、クライアント露出なし

### 📱 Next.js App Router 固有
- [ ] **'use client'**: 必要なコンポーネントのみに指定
- [ ] **Server/Client境界**: 適切な分離
- [ ] **メタデータ**: page.tsx での適切な設定
- [ ] **ルーティング**: 動的ルート [roomId] の適切な処理

---

## 禁止事項（自動指摘対象）

| 項目 | 理由 |
|------|------|
| `any` 型の使用 | 型安全性の破壊 |
| インラインスタイル | Tailwind CSS を使用 |
| `console.log` の残留 | 本番デバッグ情報漏洩 |
| 直接の DOM 操作 | React の仮想DOM と競合 |
| `eslint-disable` コメント | ルール無視は禁止 |
| ハードコードされた文字列 | 将来のi18n対応を阻害 |

---

## 追加の提案（任意）

レビュー時に以下の観点で改善提案があれば記載:
- 工数小で効果大の改善案
- 既存コードとの整合性向上
- 将来の拡張性を考慮した設計

---

## カテゴリ凡例

| カテゴリ | 説明 |
|---------|------|
| TYPE | 型定義・型安全性 |
| PERF | パフォーマンス |
| SYNC | リアルタイム同期 |
| GAME | ゲームロジック |
| UI | UI/UXデザイン |
| A11Y | アクセシビリティ |
| SEC | セキュリティ |
| NEXT | Next.js固有 |
| STYLE | コーディングスタイル |
